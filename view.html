<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <meta charset="UTF-8">
    <title>해지신청서 상세조회</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; padding: 30px; font-family: 'Pretendard', sans-serif; }
        .view-card { background: white; max-width: 800px; margin: auto; padding: 40px; border-radius: 15px; border: 1px solid #ddd; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .stamp { border: 2px solid red; color: red; display: inline-block; padding: 5px 15px; transform: rotate(-15deg); font-weight: bold; float: right; border-radius: 5px; }
        .label { font-weight: bold; background: #f8f9fa; width: 160px; vertical-align: middle; color: #555; }
        .signature-img { border: 1px solid #eee; max-width: 400px; height: auto; min-height: 100px; background: #fff; }
        .text-primary { color: #e6007e !important; } /* U+ 핑크 강조 */
        @media print { .no-print { display: none !important; } }
        .no-print { transition: opacity 0.2s; }
    </style>
</head>
<body>

<div class="view-card" id="printArea">
    <div class="stamp">완료</div>
    <h2 class="text-center mb-5" style="color: #333; font-weight: 800;">U+우리가게패키지 해지 신청서 작성 내용</h2>

<table class="table table-bordered">
    <tr><td class="label">청구서 번호</td><td id="v-bill" class="fw-bold text-danger">로딩 중...</td></tr>
    <tr><td class="label">고객명</td><td id="v-name">로딩 중...</td></tr>
    <tr><td class="label text-primary">연락처</td><td id="v-tel" class="fw-bold">로딩 중...</td></tr>
    <tr><td class="label">해지 상품</td><td id="v-products" class="fw-bold text-primary">로딩 중...</td></tr>
    <tr><td class="label">CCTV 상태</td><td id="v-cctv" class="fw-bold">로딩 중...</td></tr>
    <tr><td class="label">회수 주소</td><td id="v-returnAddr">로딩 중...</td></tr> </table>
    
    <div class="text-center mt-5 no-print">
        <button class="btn btn-primary no-print me-2" onclick="window.print()" style="background: #e6007e; border: none; padding: 10px 25px;">이 신청서 인쇄하기</button>
        <button class="btn btn-success no-print" onclick="downloadImage()" style="padding: 10px 25px;">이미지 파일로 저장</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const bill = params.get('bill');
    
    // 사장님의 최신 GAS 배포 URL
    const gasUrl = "https://script.google.com/macros/s/AKfycbytunS40kGPaQq39ZJZ_JAiqTbBCRPUNo_6yJhL-xwTFuJ0Kc7eaVEiv1dQcWHUWfEO/exec";

if (bill) {
        fetch(`${gasUrl}?bill=${bill}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.result !== "error") {
                    // 1. 기본 데이터 매칭
                    document.getElementById('v-bill').innerText = data.billNumber || "-";
                    document.getElementById('v-name').innerText = data.custName || "-";

                    // 2. 연락처(전화번호) 가공 로직
                    let tel = String(data.custTel || ""); 
                    tel = tel.replace(/[^0-9]/g, ""); // 숫자가 아닌 문자 제거

                    // 0이 빠진 10자리(1012345678) 대응
                    if (tel.length === 10 && tel.startsWith('1')) {
                        tel = '0' + tel;
                    }

                    // 하이픈 추가 (010-0000-0000 또는 02-000-0000 등)
                    if (tel.length === 11) {
                        tel = tel.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                    } else if (tel.length === 10) {
                        tel = tel.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                    }
                    document.getElementById('v-tel').innerText = tel || "-";

                    // 3. 항목 매칭 (설치주소 태그 v-addr에 회수주소 데이터 바인딩)
                    document.getElementById('v-products').innerText = data.products || "-";
                    document.getElementById('v-cctv').innerText = data.cctvStatus || "-";
                    
                    // 설치주소(v-addr) 자리에 회수주소(returnAddr)를 표시합니다.
                    // 앱스크립트 doGet에서 returnAddr를 보내주어야 정상 출력됩니다.
                    document.getElementById('v-returnAddr').innerText = data.returnAddr || "-";

                } else {
                    alert("데이터를 찾을 수 없습니다. 청구번호를 다시 확인해주세요.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("데이터 로드 중 오류가 발생했습니다.");
            });
    }

function downloadImage() {
    const target = document.getElementById("printArea");
    html2canvas(target, { useCORS: true, scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        const name = document.getElementById('v-name').innerText;
        const billNo = document.getElementById('v-bill').innerText;
        link.download = `해지신청서_${name}_${billNo}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}
</script>
</body>
</html>
