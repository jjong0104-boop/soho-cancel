<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <meta charset="UTF-8">
    <title>해지신청서 상세조회</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; padding: 30px; }
        .view-card { background: white; max-width: 800px; margin: auto; padding: 40px; border: 1px solid #ddd; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .stamp { border: 2px solid red; color: red; display: inline-block; padding: 5px 10px; transform: rotate(-15deg); font-weight: bold; float: right; }
        .label { font-weight: bold; background: #f8f9fa; width: 150px; }
        .signature-img { border: 1px solid #eee; max-width: 300px; }
        @media print { .no-print { display: none !important; } }
.no-print { transition: opacity 0.2s; } /* 옵션: 마우스 올릴 때 부드럽게 */
    </style>
</head>
<body>

<div class="view-card" id="printArea">
    <div class="stamp">완료</div>
    <h2 class="text-center mb-5">U+우리가게패키지 해지신청서 (응답내용)</h2>
    
   <table class="table table-bordered">
    <tr><td class="label">청구서 번호</td><td id="v-bill">로딩 중...</td></tr>
    <tr><td class="label">고객명</td><td id="v-name">로딩 중...</td></tr>
    <tr><td class="label">설치 주소</td><td id="v-addr">로딩 중...</td></tr>
    <tr><td class="label">해지 상품</td><td id="v-products">로딩 중...</td></tr>
    <tr><td class="label">해지 사유</td><td id="v-reasons">로딩 중...</td></tr>
    
    <tr>
        <td class="label">CCTV 확인사항</td>
        <td>
            <div id="v-cctv" class="fw-bold mb-2">로딩 중...</div>
            <div style="background: #fff; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                <table class="table table-sm table-bordered text-center mb-0" style="font-size: 0.85rem;">
                    <thead><tr class="table-light"><th colspan="2">약정 도중 해지 시 발생 비용 (부가세 포함)</th></tr></thead>
                    <tbody>
                        <tr><td class="bg-light w-50">신규설치비 반환금</td><td class="text-start ps-2">실내-94,600원 / 실외-126,500원</td></tr>
                        <tr><td class="bg-light">철거비</td><td class="text-start ps-2">실내-22,000원 / 실외-27,500원</td></tr>
                    </tbody>
                </table>
            </div>
        </td>
    </tr>

    <tr>
        <td class="label">고객 서명</td>
        <td><img id="v-sig" src="" class="signature-img" alt="서명을 불러오는 중입니다..."></td>
    </tr>
</table>
    
    <div class="text-center mt-5 no-print">
    <button class="btn btn-primary no-print me-2" onclick="window.print()">이 신청서 인쇄하기</button>
    <button class="btn btn-success no-print" onclick="downloadImage()">이미지 파일로 저장</button>
</div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const bill = params.get('bill');
    
    // 사장님의 최신 GAS 배포 URL을 확인하세요
    const gasUrl = "https://script.google.com/macros/s/AKfycbziZaen7Go8I6ahaEOgI8hc362opbp-19jPQvNylDfEBY_varV-VKFwBQ2BeULiwr27/exec";

    if (bill) {
        fetch(`${gasUrl}?bill=${bill}`)
            .then(res => res.json())
            .then(data => {
                if(data) {
                    // GAS의 doGet에서 정의한 이름(Key)과 100% 일치시켜야 함
                    document.getElementById('v-bill').innerText = data.billNumber || "-";
                    document.getElementById('v-name').innerText = data.custName || "-";
                    document.getElementById('v-addr').innerText = data.address || "-";
                    document.getElementById('v-products').innerText = data.products || "-";
                    document.getElementById('v-reasons').innerText = data.reasons || "-";
                    
                    if (data.signature) {
                        document.getElementById('v-sig').src = data.signature;
                    }
                } else {
                    alert("해당 번호의 신청서 데이터를 찾을 수 없습니다.");
                }
            })
            .catch(err => alert("데이터를 불러오는 중 오류가 발생했습니다."));
    }
    // script 태그 맨 아래에 추가
function downloadImage() {
    // 캡처할 영역 지정 (신청서 카드 전체)
    const target = document.getElementById("printArea");
    
    // 버튼 등 필요 없는 요소는 잠시 숨김 처리 (no-print 클래스 활용)
    html2canvas(target, {
        useCORS: true, // 외부 이미지(서명 등) 허용
        scale: 2       // 화질을 2배로 높임
    }).then(canvas => {
        const link = document.createElement('a');
        const name = document.getElementById('v-name').innerText;
        const bill = document.getElementById('v-bill').innerText;
        
        link.download = `해지신청서_${name}_${bill}.png`; // 파일명 설정
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}
</script>
</body>
</html>
